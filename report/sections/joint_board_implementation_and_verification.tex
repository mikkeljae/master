%!TEX root = ../main.tex
\subsection{Implementation and Verification} % (fold)
\label{sub:implementation_and_verification}
This section will elaborate on the implementation of the design created in section \ref{sub:analysis}.
Specifically the methods and equipment used is discussed.
In addition, the verification of the finished product is presented in appropriate detail.
This will give the reader an impression of the method used to verify the implementation.
\subsubsection{Mechanics Implementation} % (fold)
\label{ssub:mechanics_implementation}
The joint design created in the previous section was manufactured by the SDU Workshop.
As the more experienced mechanical technicians at the workshop worked through the design they worked with the authors to improve on the design to make it practically possible to construct.  
% subsubsection mechanics_implementation (end)
\subsubsection{Verification Methodology} % (fold)
\label{ssub:testing_methodology}
From experience of the authors, verification of a PCB design can become difficult without a predefined plan, increasing the risk of mistakes, oversights and similar problems.
In order to minimize the risk of these, it was decided to create a verification method prior to the actual verification of the PCB.
Each verification procedure is written to reflect the features created in the design.
Each of these features should be tested, in the intended order.
It should be written such that the verification can be done with no prior knowledge of the operation of the design.
This approach holds a few different benefits.
Firstly, the technician doing the verification is doing less thinking while verifying, this is likely to decrease the number of mistakes.
Secondly, a thorough verification procedure will enable students to more easily reproduce the PCB's if necessary.\\~\\
Each procedure is presented in the report with the results as gathered by the authors.
A version suitable for future use can be found in appendixes \ref{sec:controller_board_verification_procedure} and \ref{sec:joint_board_verification_procedure}.
% subsubsection testing_methodology (end)

\subsubsection{Joint Board Verification Procedure} % (fold)
\label{ssub:joint_board_verification_methodology}
This is the verification procedure as done by the authors.
A step is given a checkmark to indicate a succesful test.
A step is given an x to indicate a test with issues.
A comment is given to explain the issue as well as the solution to the issue.
\paragraph{Verify Voltage Rails:} % (fold)
 \label{par:verify_voltage_rails}
 \begin{itemize}
 	\item Apply 3.7V to \texttt{VBATT}.
 	\begin{itemize}
 		\item[\xmark] Verify that current draw is within reasonable limits ($<$75 mA). Note that the PCB requires a short pulse of approximately 0.89A while booting.
 		\begin{itemize}
 			\item[-] A short circuit seemed to exist on the 5V rail.
 			See next paragraph.
 		\end{itemize}
 		\item[\xmark] Verify 5V and 3.3V voltage rails.
 		\begin{itemize}
 			\item[-] The 3.3V rail functions as intended but the 5V rail is missing.
 			From inspection of the circuit it was discovered that the diode D1 has a fault in the footprint.
 			The six-pin package can be flipped and the centre legs lifted to resolve the issue.
 			During testing the lab supply used to power the board was limited to $\approx$250mA which, due to the required startup current, yielded what looked like a short circuit.
 			Figure \ref{fig:joint_curr_limit} shows the current spike and the resulting failure of the 5V rail to rise.
 			In an attempt to find the offending component the current limit was raised to $\approx$1A.
 			This allowed the 5V rail to properly boot, leading to the discovery of the required startup current.
 			According to the datasheet of the SP6641 \cite{sp6641b} it requires a startup current of $\approx$0.65A. 
 			The resulting current draw and voltage can be seen in figure \ref{fig:joint_no_curr_limit}.
 			\thomas{Why is the 5V rail supposedly only going to 3.6V in figure \ref{fig:joint_no_curr_limit}?}
 		\end{itemize}
 	\end{itemize}
 \end{itemize}
% paragraph verify_voltage_rails_ (end) 

\begin{figure}[h]
	\centering
	\input{graphics/joint_board_test_fig1.tex}
	\caption{Voltage of the 5V rail and current draw of the joint board during startup with current limit of $\approx$ 250mA.}
	\label{fig:joint_curr_limit}
\end{figure}

\begin{figure}[h]
	\centering
	\input{graphics/joint_board_test_fig2.tex}
	\caption{Voltage of the 5V rail and current draw of the joint board during startup with current limit of $\approx$ 1A}
	\label{fig:joint_no_curr_limit}
\end{figure}

\paragraph{Verify Voltage Level Shifter Functionality} % (fold)
\label{par:verify_voltage_level_shifter_functionality}
\begin{itemize}
	\item Apply 5V to \texttt{SCLK\_H}.
	\begin{itemize}
		\item[\cmark]  Verify that 3.3V is present on \texttt{SCLK}.
	\end{itemize}
	\item Repeat for signals \texttt{MOSI\_H} and \texttt{RESET\_H}.
	\item Apply 3.3V to \texttt{MISO}.
	\begin{itemize}
		\item[\cmark]  Verify that 5V is present on \texttt{MISO\_H}.
	\end{itemize}
\end{itemize}
% paragraph verify_voltage_level_shifter_functionality (end)

\paragraph{Verify RS-422 Circuitry Functionality} % (fold)
\label{par:verify_rs_422_circuitry_functionality}
\begin{itemize}
	\item Apply 5V to \texttt{A\_N}, 0V to \texttt{A\_P}.
	\begin{itemize}
		\item[\cmark] Verify that 0V is present on \texttt{A\_H}.
		\item[\cmark] Verify that 0V is present on \texttt{A}.
	\end{itemize}
	\item Repeat for signal pairs \texttt{B\_N}, \texttt{B\_P} and \texttt{Z\_N}, \texttt{Z\_P}.
	\item Apply 0V to \texttt{A\_N}, 5V to \texttt{A\_P}.
	\begin{itemize}
		\item[\cmark] Verify that 5V is present on \texttt{A\_H}.
		\item[\cmark] Verify that 3.3V is present on \texttt{A}.
	\end{itemize}
	\item Repeat for signal pairs \texttt{B\_N}, \texttt{B\_P} and \texttt{Z\_N}, \texttt{Z\_P}.
\end{itemize}
% paragraph verify_rs_422_circuitry_functionality (end)
\paragraph{Verify ATtiny84 Functionality} % (fold)
\label{par:verify_attiny84_functionality}
\begin{itemize}
	\item Load the ATtiny84 with the blink software.
	\begin{itemize}
		\item[\xmark] Verify that the on-board LED is blinking
		\begin{itemize}
			\item[-] The software was loaded successfully occasionally but would often fail.
			This was found to be due to missing pull-up on the \texttt{RESET} pin.
			A pull-up resistor of 3.92k$\Omega$ can be placed on signals \texttt{RESET\_H} and \texttt{5V}.
			The pull-up resistor cannot be placed on the ATtiny84 since the 74LCX244 and the ATtiny84 would otherwise both attempt to drive the \texttt{RESET} net.
		\end{itemize}
	\end{itemize}
\end{itemize}

In later debugging it was revealed that the 74LCX244 and ATtiny84 both attempt to drive the \texttt{SCLK} and \texttt{MOSI} nets, resulting in the communication with the nRF24L01 module not functioning.
This is a design error and should be fixed in later versions of the design.
A temporary fix was done by soldering a wire to the enable pin of the 74LCX244 and connecting it to a switch connected to \texttt{GND} and \texttt{5V}, effectively creating a programming mode and a running mode.
In the programming mode the 74LCX244 is enabled and has control over the affected nets.
In running mode the 74LCX244 is disabled and the ATtiny84 is capable of driving the affected nets.
% paragraph verify_attiny84_functionality (end)
% subsubsection joint_board_verification_methodology (end)
\subsubsection{Circuit Power Draw and Run-time} % (fold)
\label{ssub:circuit_power_draw_and_runtime}
In section \ref{par:power_delivery} it was found that the circuit would require $\approx$462mW when transmitting.
In testing it was found that the circuit draws 117mA at 3.7V or 432.9mW.
Since the original numbers were calculated based on maximum values from the datasheets of the components used in the calculation it is reasonable to see a slightly lower number.
\\~\\
The battery chosen for this application has 1600mWH of capacity resulting in a theoretical run-time of $\approx$3:45 hours
\thomas{insert actual real number.}
This is clearly not as high as what was desired (10 hours).
The main reason for this is the unexpectedly large power draw of the encoder and the accompanying RS422 decoder.
The DS26LS32CM RS422 decoder draws 52mA at 5V.
The Rolin Encoders are available in versions which output TTL signals meaning that the decoder could be removed. 
Unfortunately, the encoders with this output do not have a unique reference mark and as such it would not be possible to properly calibrate the joint.
% subsubsection circuit_power_draw_and_runtime (end)
% subsection implementation_and_verification (end)