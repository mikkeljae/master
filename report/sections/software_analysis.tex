%!TEX root = ../main.tex
\subsection{Software Analysis} % (fold)
\label{sub:software_analysis}

\subsubsection{Joint Board Software} % (fold)
\label{ssub:joint_board_software}
The joint board is responsible for maintaining knowledge of the position of its joint and transmitting that position to the controller board.
The RL2IC encoder implements incremental quadrature with three signals: \texttt{A}, \texttt{B} and \texttt{Z}.
Figure \ref{fig:quadrature} is a depiction of this quadrature scheme.
The two signals \texttt{A} and \texttt{B} are 90$^\circ$ out of phase and their frequency is determined by the angular velocity of the joint.
As can be seen from the figure the signals create four unique stages, counting these allows knowledge of both the direction, position and, potentially, the velocity of the joint.

\begin{figure}[h]
	\centering
	\includegraphics[width=.5\linewidth]{graphics/quadrature}
	\caption{Incremental quadrature scheme as implemented on the RL2IC encoder.}
	\label{fig:quadrature}
\end{figure}
% subsubsection joint_board_software (end)

\subsubsection{Interboard Communication} % (fold)
\label{ssub:interboard_communication}
As mentioned in section \ref{}, communication between the controller board and the joint boards is to happen wirelessly using the nRF24L01 module.
\thomas{find section where wireless transmission is decided}
Throughout this section this aspect is explored further.
Specifically it will be determined what data is required to be sent, and how often it is sent.
The joint board should continuously transmit the angular position of the joint, the current direction of movement, whether calibration has occured since startup and, since there are two joint boards, its id.
The RL2IC encoder used in the joint produces 7200 counts per revolution, requiring 13 bits to represent a full revolution of the joint.
Since direction, calibration and id are all binary situations, the total required message size is 16 bit.
See figure \ref{fig:rfpacket} for a visual representation of the message.

\begin{figure}[h]
	\centering
	\includegraphics[width=.5\linewidth]{graphics/rf_packet}
	\caption[Structure of a packet used on the RF transmission between the joint boards and the controller board.]{Structure of a packet used on the RF transmission between the joint boards and the controller board. Bits 0-12 represent the current angular position, bit 13 represents the direction of motion, bit 14 represents the state of calibration and bit 15 represents the id of the joint.}
	\label{fig:rfpacket}
\end{figure}

With knowledge of the message size, it is possible to determine the theoretical maximum transmission rate.
The nRF24L01 module is capable of transmitting up to 2Mbps.
It uses Enhanced Shockburst, a protocol developed by Nordic Semiconductor specifically for their RF modules.
This protocol adds an overhead for each packet of 6 bytes, including a CRC check and an address, amongst a few other features.
Each packet is therefore $\approx$ 8 bytes with only 25\% of the packet being the intended payload.
This effectively limits the data rate to 0.5Mbps.
It is therefore possible to transmit a position at a rate of 31250Hz.
Since the two joints are communicating with the same module on the controller board, this frequency is halved resulting in 15625Hz.
Transmission at this frequency does entail a few problems, discussed in the following paragraphs.
\paragraph{nRF24L01 Mode Cycling}~\\ % (fold)
\label{par:nrf24l01_mode_cycling}
When transmitting at a rate of 15625Hz a message is to be sent every 64$\mu$s
According to the datasheet of the nRF24L01 it can be kept in transmit mode for no longer than 4ms, meaning that at the most 62 packets can be sent before cycling to standby-mode and back to TX-mode.
Before entering TX-mode a 130$\mu$s settling period is inferred.
This means that at least two packets are lost during this time.
The problem can be overcome by lowering the transmission frequency such that the time between packets is above 130$\mu$s.
6.5kHz transmission frequency would result in $\approx$154$\mu$s delay, enough time to cycle between the modes between each packet.
% paragraph nrf24l01_mode_cycling (end)
\paragraph{Air Collisions}~\\ % (fold)
\label{par:air_collisions}
There is a risk that two packets will collide if the joints transmit at the same time.
Due to uneven drift between the two microcontrollers on the joints it is unlikely that collisions will occur indefinitely, however even a few lost packets in a row can cause severe problems in the control of the pendulum.
The lowered transmission frequency alleviates this issue somewhat, but there is still a risk that multiple packets may be lost.
Air collisions could be overcome altogether by using the acknowledge feature in the Enhanced Shockburst protocol, this enables the module to resend a message if an ACK message has not been received within 250$\mu$s.
After 250$\mu$s however, the previous position is outdated and the new position should be sent rather than the lost position.
Additionally, the ACK message adds 15 bytes to the transmission of each packet, greatly lowering the possible throughput.
The nRF24L01 is capable of operating on different frequencies.
By adding a second receiver on the controller board the two joints can communicate on different frequencies, eliminating the risk of air collisions altogether.
This realisation was made after the controller board was produced and so the additional nRF24L01 has to be retrofitted on the board. 
% paragraph air_collisions (end)
\\~\\
In order to simplify communication between the joint boards and the controller board communcation will be one way only.
This allows the nRF24L01's on the controller board to stay in RX-mode, listening for new positions from the joints continuously.
The joint boards will, upon powering up, immediately start transmitting the packet mentioned in figure \ref{fig:rfpacket}.
%subsubsection interboard_communication (end)
%subsection software_analysis (end) 
