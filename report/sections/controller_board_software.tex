%!TEX root = ../main.tex
\section{Controller Software Development} % (fold)
\label{sub:controller_board_software}

\subsection{Analysis} % (fold)
\label{sub:analysis}

\subsubsection{Requirements} % (fold)
\label{ssub:controller_requirements}

\subsection{Implementation} % (fold)
\label{sub:implementation}

\subsubsection{nRF24L01} % (fold)
\label{subs:nrf24l01}
~\\
The \texttt{nRF24L01} is interfaced through a standard SPI connection and a \texttt{CE} pin that is used to activate the chip. 
It also has a interrupt pin, but it was chosen not to use it and instead poll the device. 
Configuration of the device is done through SPI.

\paragraph{Writing to a Register} % (fold)
\label{par:writing_to_a_register}
~\\
% subparagraph writing_to_a_register (end)
\mikkel{Put in figure and talk about it}

\begin{listing}[h]
\begin{minted}{c}

#define W_REGISTER      0b00100000
#define REGISTER_MASK   0b00011111

void RF_write_register(XSpiPs *SPI_inst, u8 reg, u8 value){
	u8 output =  (W_REGISTER | ( REGISTER_MASK & reg));
	u8 output_buffer[] = {output, value};
	XSpiPs_PolledTransfer(SPI_inst, output_buffer, NULL, 2);
}
\end{minted}
\caption{Implementation of a C function that writes a register value to a specific register on the \texttt{nRF24L01}. Defines are shown for clarity.}
\label{code:rf_write_register}
\end{listing}

\mikkel{Put in figure of SPI signals from scope}




\begin{listing}[h]
\begin{minted}{c}
#define R_RX_PAYLOAD       0b01100001
#define PAYLOAD_SIZE       32

void RF_read(XSpiPs *SPI_inst, u8 *buffer){
	u8 input_buffer[33], output_buffer[PAYLOAD_SIZE+1];
	output_buffer[0] = R_RX_PAYLOAD;
	XSpiPs_PolledTransfer(SPI_inst, output_buffer, input_buffer, PAYLOAD_SIZEsdjfoasjdfoasjdopfjasdpofjsdopfjaospdfjopasdjfopasdfjopspodfjoaspdfjopasdfjopasdfjop+1);
	int i;
	for(i = 1; i < PAYLOAD_SIZE+1; i++){
		buffer[i-1] = input_buffer[i];
	}
}


	signal_1  <= resize((window(0,0)+window(0,1)+window(0,2)+window(1,0) +window(1,1)+window(1,2)+window(2,0)+window(2,1)+window(2,2))/9,8);
\end{minted}
\caption{Implementation of a C function that reads 32 bytes payload from the \texttt{nRF24L01}. Defines are shown for clarity.}
\label{code:rf_write_register}
\end{listing}

\subsection{Verification} % (fold)
\label{sub:verification}
