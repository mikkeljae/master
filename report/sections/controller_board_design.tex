%!TEX root = ../main.tex
\subsection{Circuit Design}
\label{sub:controller_board_circuit_design}

Multiple electronics components are required to realise the functionalities described in the requirement specification.
This section explores the selection of those components and design of the corresponding circuits.

\subsubsection{MOSFETs and H-Bridge Driver} % (fold)
\label{ssub:h_bridge}
The motor that needs to be driven is a Maxon 148867 Brushed DC Motor.
This is a 150W motor with a nominal current of 6A and a stall current of 80A.
Clearly, the system should under normal use not come anywhere close to stalling the motor but considering the use case, experimentation with control algorithms from users, it may be beneficial to design the circuitry such that it can withstand being stalled, for at least a short period of time.
In order to reach this goal, it is necessary to size the components for at least some amount above 80A continuous.
The \texttt{IRF100B202} MOSFET \cite{mosfet} is a 100V/97A MOSFET.
It is made in the standard TO-220 housing.
This housing allows for easy mounting of a heatsink and due to its wide application, there are many shapes and sizes to choose from.
Table \ref{tab:mosfetparameters} holds a list of the relevant parameters.

\begin{table}[h]
	\centering
	\begin{tabular}{|r|c|c|c|}
	\hline
		\textbf{Parameter} & \textbf{Min} & \textbf{Typ} & \textbf{Max} \\
	\hline
		$V_{\text{th}}$ [V] & 2 & - & 4 \\
	\hline
		$R_{\text{ds(on)}}$ [m$\Omega$]& - & 7.2 & 8.6 \\
	\hline
		$Q_\text{g}$ [nC] & - & 77 & 116 \\
	\hline
		$I_\text{d}$ [A] & - & - & 97 \\
	\hline
		$V_{\text{ds}}$ [V] & 100 & - & - \\
	\hline
	\end{tabular}
	\caption[Relevant parameters of the \texttt{IRF100B202} MOSFET.]{Relevant parameters of the \texttt{IRF100B202} MOSFET \cite{mosfet} chosen for the full-bridge.
	Here, \vth is the gate threshold voltage, \ron is the drain-source on resistance, \qg is the total gate charge, \id is the maximum continuous drain current and \vds is the minimum guaranteed drain-source breakdown voltage.}
	\label{tab:mosfetparameters}
\end{table}

It should be noted that even though \vth is maximum 4V, this is not enough to fully open the MOSFET.
Rather, this voltage is where the MOSFET will start to conduct.
Figure \ref{fig:mosfettransfercharacteristic} reveals that the MOSFET is not fully conducting until \vgs $>6$V.

\begin{figure}[H]
	\centering
	%\includegraphics[width=0.6\linewidth]{graphics/mosfet_transfer_characteristic}
	\caption[Transfer characteristic of the IRF100B202.]{Transfer characteristic of the \texttt{IRF100B202} as per the datasheet.
	Inspecting the graph reveals that the maximum \id of 97A is reached at \vgs$\approx5.5\rightarrow6.5$V.}
	\label{fig:mosfettransfercharacteristic}
\end{figure}
 
Having chosen a MOSFET for the full-bridge, some form of driver must be designed for the full-bridge.
For this task, ready-made full-bridge drivers exist on the market that incorporate all of the electronics required to generate the driving signals, requiring only a PWM signal from the designer.
In order to choose one, a few parameters must be fulfilled.

\begin{itemize}
	\item \textbf{Output Current:} The amount of current necessary to properly drive the MOSFET.
	This value depends on the switching frequency of the application, the gate-to-source voltage ($V_{gs}$) and the total gate charge of the MOSFET.
	\item \textbf{Driving Voltage:} In order to ensure that the MOSFET is turned on quickly and fully the driver should be able to supply a voltage well above the gate threshold of the MOSFET.
	\item \textbf{High-Side Drive Capabilities:} The high side MOSFET of the full-bridge is referenced not to ground, but to a floating reference.
	This means that in order to switch on this MOSFET, $V_{\text{gate}}$ needs to be boosted compared to the floating reference. 
	This is bootstrapping and is explained in more detail in section \ref{ssub:bootstrap_circuit}.
	\item \textbf{Shoot-Through Protection and Deadtime:} Due to the structure of the full-bridge it is important that two MOSFETs on the same half-bridge are never \texttt{on} at the same time as this would result in a short from $V_{\text{cc}}$ to ground.
	This is resolved with a combination of deadtime (a delay where no MOSFET is \texttt{on}) and a logic table that ensures that an illegal switch combination can never happen.
\end{itemize}

The \texttt{HIP4081AIBZ} \cite{driver} full-bridge driver meets all of the above requirements.
It can supply up to 2.5A on the output pins with a voltage approximately 1V below \vcc, well above the required \vth.
It also allows for an external bootstrap circuit, which makes it able to drive the high-side MOSFETs.
Since the motor should, preferably, be driven outside the audible frequency range, it was chosen to set the switching frequency at 22kHz.
This frequency was chosen over an even higher frequency because increasing the frequency also increases the switching losses.
At this frequency there is $\frac{1}{22000}\approx45\mu$S per cycle. 
Well within this time the gate should be fully opened.
The switching time should be calculated to verify this.
\cite{mosfet_switch_app_note} describes switching characteristics of MOSFETs without taking parasitics into account.
Approximating the turn-on time of the MOSFET is sufficient here as it just needs to be verified that the MOSFETs are fully open within a small fraction of the switching period.
\cite{mosfet_switch_app_note} approximates the turn-on time of a MOSFET in equation \ref{eq:mosfet_turn_on}.

\begin{equation}
t_{switch} = R_G \cdot C_{iss} \cdot ln\left(\frac{1}{1-\frac{V_{gp}}{V_{GS}}}\right) 
\label{eq:mosfet_turn_on}
\end{equation}

Where $t_{switch}$ is the switching time, $R_G$ is the total gate resistance, $C_{iss}$ is the effective input capacitance of the
MOSFET, $V_{gp}$ is the gate plateau voltage and $V_{GS}$ is the voltage applied to the gate by the motor driver.
Accounting for voltage drops in the bootstrap circuit discussed later,  it is assumed that \vgs is 8V and by inspecting figure \ref{fig:mosfettransfercharacteristic}, $V_{gp}$ is estimated to 4.5V.
$R_G$ and $C_{iss}$ are   datasheet values.

\begin{equation}
t_{switch} = 9.4 \cdot 4.48 \cdot 10^{-9} \cdot ln\left(\frac{1}{1-\frac{4.5}{8}}\right) = 34.8 nS 
\label{eq:mosfet_turn_on_values}
\end{equation}
This MOSFET switching time is orders of magnitude smaller than the PWM switching period.

The component also has floating drive circuitry, meaning that by referencing the high-side driver to source of the high-side MOSFET, the driver can be made to output a voltage higher than \vcc.
This does require a few external components for bootstrapping.
The choice of these components and a more in depth explanation of the procedure is given in section \ref{ssub:bootstrap_circuit}.
Finally, the component has a user-programmable dead time and shoot-through protection. 

\subsubsection{Bootstrap Circuit}
\label{ssub:bootstrap_circuit}
\begin{figure}[h]
	\centering
	\includegraphics[width=0.6\linewidth]{graphics/hip_bootstrap}
	\caption[Bootstrap circuitry]{Bootstrap circuitry consisting of a diode, a capacitor and a resistor. }
	\label{fig:hip_bootstrap}
\end{figure}	
The chosen gate driver has floating drive circuitry for the high side MOSFETS but needs external bootstrap circuitry for providing the higher voltage. 
A standard bootstrap circuits consists of a diode, a capacitor and a resistor as shown in figure \ref{fig:hip_bootstrap}.
The advantage of using a bootstrap circuit to supply a high voltage for the floating drive is that it is very simple. 
The disadvantage is that it sets a limit for the maximum and minimum duty cycle as the bootstrap capacitor needs to be charged fully in each period.
The bootstrap circuitry for this project will be designed to have a maximum duty cycle for the higher MOSFETS of 95\%, thus meaning that the charging of the bootstrap capacitor should take no longer than 5\% of a period.  

The bootstrap diode needs to have a fast recovery time, preferably below 100 ns \cite{bootstrap_infineon}, to minimize the energy fed back to the supply from the bootstrap capacitor.
\texttt{US1M-E3} \cite{diode_ds} was chosen as it has a reverse recovery time of 75 ns and comes in SMD packaging. 
It allows for a maximum average forward current of 1 A and a maximum forward voltage drop of 1.7 V \cite{diode_ds}.
Determining the values for the bootstrap capacitor was done using the calculations shown in \cite{bootstrap_ON}.
The maximum allowed voltage drop across the bootstrap capacitor during \texttt{on} time needs to be determined: 
\begin{equation}
\Delta V_{boot} = V_{DD} - V_{F} - V_{GSMIN}
\end{equation}
Where $\Delta V_{boot}$ is the voltage drop across the bootstrap capacitor during \texttt{on} time, $V_{DD}$ is the supply voltage, $V_F$ is the forward voltage drop across the diode and $V_{GSMIN}$ is the minimum desired \texttt{gate-source} voltage.
$V_{GSMIN}$ was chosen to 8 V to to ensure a high enough gate voltage to turn on the MOSFETS. 
The chosen MOSFETS have a maximum gate threshold voltage of 3.5 V. 
Inserting the values yields the maximum allowed value of $\Delta V_{boot}$:
\begin{equation}
\Delta V_{boot} = 12 - 1.7 - 8 = 2.3 V	
\end{equation}

The total charge that needs to be supplied from the bootstrap capacitor is the gate charge of the MOSFET along with the quiescent and leakage currents in the \texttt{on} time:
\begin{equation}
	Q_{total} = Q_{gate} + Q_{ls} + (I_{lkgs} + I_{qbs} + I_{lk} + I_{lkd}) \cdot t_{on}
	\label{eq:charge_total}
\end{equation}
Where $Q_{gate}$ is the maximum total gate charge, $I_{lkgs}$ is the gate-source leakage current, $I_{qbs}$ is the gate driver quiescent current, $I_{lk}$ is the gate driver leakage current, $I_{lkd}$ is the diode leakage current, $ t_{on}$ is the \texttt{on} time and $Q_{ls}$ is the charge required by the internal level shifter in the gate driver.
\begin{table}[h]
\centering
\begin{tabular}{|l|l|l|l|l|l|l|}
 \hline
 $Q_{gate}$ 	& $Q_{ls}$ 	& $I_{lkgs}$ 	& $I_{qbs}$ 		& $I_{lk}$ 			& $I_{lkdiode}$ 	& $t_{on}$ 		\\ 	\hline
 $116$ [nC]		& $3$ [nC]	& $100$ [nA]	&$-30$ [$\mu$A]		& $1$ [$\mu$A]		& $1$ [nA]			& $43$ [$\mu$S]	\\ 	\hline
\end{tabular}
\caption[Parameter values used to determine total charge.]{Parameter values used in equation \ref{eq:charge_total}. $I_{qbs}$ and $I_{lk}$ are found in the gate driver data sheet. $Q_{ls}$ is set to 3nC for all high voltage gate drivers \cite{bootstrap_ON}. $I_{lkgs}$ and $Q_{gate}$ are MOSFET data sheet values and $I_{lkdiode}$  is a diode data sheet value. $t_{on}$ is calculated using 95\% dutycycle and 22kHz switching.}
\label{tab:bootstrap_parameter}
\end{table}
$t_{on}$ can be calculated knowing that the worst case duty cycle for the high side MOSFET is 95\% and the switching frequency is 22 kHz.
Inserting the values, shown in \ref{tab:bootstrap_parameter}, yields the minimum charge value of the capacitor:
\begin{equation}
	Q_{total} = 118 [nC]
\end{equation}

The minimum value of the bootstrap capacitor can now be calculated:
\begin{equation}
	C_{boot} = \frac{Q_{total}}{\Delta V_{boot}} = \frac{118}{2.3} = 51.2 [nF]
\end{equation}
A ceramic capacitor will be used as it has a negligible leakage current. 
Looking for SMD ceramic capacitors it was found that in the range of the found minimum value is 56, 68, 82 and 100 nF.
56 nF is, in theory, a big enough capacitor for the circuit, but a bigger capacitor is an advantage as $\Delta V_{boot}$ will then decrease.
When increasing the size of the capacitor it should be noted that the initial charge current will become larger.
It was therefore chosen to use a 100 nF ceramic capacitor.

The initial charge current to the capacitor needs to be limited in order not to exceed the maximum ratings of the diode.
Therefore a resistor is put in series with the diode.
The resistor value should not be too big as the voltage drop across it is subtracted from the bootstrap capacitor voltage.
A 4.7 $\Omega$ resistor was chosen. In this setting, the maximum current through this component is 2.6 A.
This is clearly above the maximum average forward current of the diode at 1A.
The diode can however, withstand an 8.3 ms single half sine-wave of maximum 30 A \cite{diode_ds}.
The capacitor voltage while charging in a RC circuit is described by equation \ref{eq:cap_charge}, according to \cite{prac_ele_for_inven}.

\begin{equation}
	V_C = V_S (1-e^{\frac{-t}{R\cdot C}})
	\label{eq:cap_charge}
\end{equation}

Where $V_C$ is the capacitor voltage, $V_S$ is the supply voltage, $R$ is the resistance and $C$ is the capacitance.
The RC time constant is defined as $\tau = R\cdot C$.
Equation \ref{eq:cap_charge} can be used to calculate the time it takes an RC circuit to charge to a specific level.
After one time constant the capacitor is charged 63.2\% and after five time constant the capacitor is approximately fully charged, 99.3\%.
This knowledge can be used to calculate the time it takes to initially charge the bootstrap capacitors as shown in equation \ref{eq:cap_boot_time}.

\begin{equation}
T_{charge,init} = 5\cdot \tau = 5\cdot (R \cdot C) = 5\cdot (4.7 \cdot 100 \cdot 10^{-9}) = 2.35 \mu S 
\label{eq:cap_boot_time}
\end{equation}

Meaning that the diode can be exposed to a maximum of 2.6A for $2.35 \mu S $, which is well below the absolute maximum rating.
It should also be noted that bootstrap capacitor needs at least $2.35 \mu S $ for the initial charging.

Lastly it should be calculated what the maximum allowed duty cycle for the high side MOSFETS are in this configuration, using the found components.
The time it takes to charge the capacitor the energy that is used in each period is:
\begin{equation}
	T_{charge,period} = 5\cdot (R \cdot C_{boot}) = 5\cdot (4.7 \cdot  51.6 \cdot 10^{-9}) = 1.21 \mu S 
\end{equation}
The $1.21 \mu S$ is equivalent to 2.7\% duty cycle and the maximum theoretical duty cycle for the high side MOSFETS is thus 97.3\%.
% subsection power_board (end)

\subsubsection{Supply Capacitors}
\label{ssub:sup_caps}
Driving an inductive load, such as a motor, requires capacitors placed close to the MOSFETS in order to minimize the voltage spikes created by the load current and parasitic inductance in the wires from the supply.
This section will determine the size and requirements of the supply capacitors using calculations and simulation in PLECS.

First off, the ripple current across the motor needs to be determined as this is the current the supply capacitors need to supply.
Equation \ref{eq:inductor_gen} shows the general inductor equation and in \ref{eq:inductor_rip} it is refactored to calculate the ripple current.
\begin{equation}
	V(t) = L \cdot \frac{dI(t)}{dt}
	\label{eq:inductor_gen}
\end{equation}

\begin{equation}
	\Delta I = \frac{\Delta V}{L} \Delta t
	\label{eq:inductor_rip}
\end{equation}

The highest ripple current is found when the duty cycle is 50$\%$ and the full voltage of 24V is applied as calculated in equation \ref{eq:inductor_rip_size}.

\begin{equation}
	\Delta I = \frac{24}{82\cdot 10^{-6}} \cdot 0.5 \cdot \frac{1}{22000} = 6.7 [A] 
	\label{eq:inductor_rip_size}
\end{equation}

The peak-to-peak ripple current of $6.7$A is also found when simulating the system using PLECS as shown in figure \ref{fig:sim_currents}.
The load current experienced by the supply is also shown in figure \ref{fig:sim_currents}, where abrupt changes in current are seen. 

\begin{figure}[h]
	\centering
	%\input{graphics/sim_currents.tex}
	\caption[Simulating motor and load currents in Plecs.]{Current in the motor and the total load when when simulating a full bridge in PLECS.}
	\label{fig:sim_currents}
\end{figure}

This is clearly problematic and even if the supply wires have just a few nH of parasitic inductance it would correspond to a huge voltage ripple which is unwanted. 
Therefore supply capacitors needs to be added to the circuit as close to the switching MOSFETs as possible.
The minimum capacitance can be calculated by refactoring the general capacitor equation shown in \ref{eq:cap_gen} into equation \ref{eq:cap_min}.
\begin{equation} 
	I(t) = C \cdot \frac{dV(t)}{dt}
	\label{eq:cap_gen}
\end{equation}

\begin{equation} 
	C = \Delta I \cdot \frac{\Delta t}{\Delta V}
	\label{eq:cap_min}
\end{equation}
There is no specified requirements for the maximum allowable voltage ripple on such a board, but it is generally undesired.
It was decided to design the board to have a voltage ripple of less than 1V.
Using the found ripple current and a maximum voltage ripple of 1 V, the minimum value can be found by equation \ref{eq:cap_min_size}.

\begin{equation} 
	C = 6.7 \cdot \frac{0.5 \cdot \frac{1}{22000}}{1 } = 151 [\mu F]
	\label{eq:cap_min_size}
\end{equation}

It can now be decided which capacitors should be used.
It was chosen to use electrolytic capacitors as they are generally cheaper in this range of capacitance. 
Another reason to choose electrolytic capacitors is their equivalent series resistance, ESR, that will dampen the oscillations introduced by the LC circuit of the capacitors and the parasitic inductance of the wires.
When inspecting capacitor data sheets the ripple current is given in RMS values. 
The RMS value of the load current is calculated to be 1.9A.
It was chosen to use the \texttt{MAL215099911E3} \cite{sup_cap} capacitors and connecting them in parallel. 
The relevant parameters of this capacitor is shown in table \ref{tab:cap_parameters}.
Connecting two of these capacitors in parallel would yield a total allowed RMS ripple current of 2.6A, which would be enough.
To allow for some headroom it was chosen to use four, which yields a combined maximum RMS ripple current of 5.3A. 
Clearly the total capacitance of 1320$\mu$F is far above the minimum needed of 151$\mu$F, but this will only further decrease the voltage ripple.

\begin{table}[tb]
	\centering
	\begin{tabular}{|r|c|}
	\hline
		\textbf{Parameter} & \textbf{Value} \\
	\hline
		$U_r$ & 100 [V]  \\ \hline
		$C_r$ & 330 [$\mu$F]  \\ \hline
		$I_r$ RMS @ 100[kHz] & 1.4 [A]  \\ \hline
		$I_r$ RMS @ 10[kHz] & 1.3 [A]  \\ \hline
		
	\end{tabular}
	\caption[Relevant parameters of the \texttt{MAL215099911E3} capacitor.]{Relevant parameters of the \texttt{MAL215099911E3} capacitor.
	Here $U_r$ is the rated voltage, $C_r$ is the rated capacitance and $I_r$ is the ripple current.}
	\label{tab:cap_parameters}
\end{table}

The disadvantage of the electrolytic capacitors is that they are not usable for high frequency content.
Therefore it was chosen to add ceramic capacitors as they perform much better at high frequencies. 
Calculating the needed size of these is very complicated as the high frequency content is determined by the switching speed of the MOSFETS, parasitics and the circuit board layout in general. 
Based on previous experience it was decided, to use four 1$\mu$F ceramic capacitors in the \texttt{0805} housing as they can easily be changed if it turns out that more capacitance is needed.

In order to be able to simulate the system, an estimate of the inductance of the supply wires is needed.
According to \cite{partial_induc} the inductance of the wire can be estimated using equations \ref{eq:wire_induc1} to \ref{eq:wire_induc3}.

\begin{equation}
	L_p = \frac{\mu_0}{2 \pi} \cdot L \cdot \big(ln(\frac{2L}{r}-1)\big)
	\label{eq:wire_induc1}
\end{equation}
\begin{equation}
	L_i = \frac{\mu_0}{8 \pi} \cdot L
\end{equation}
\begin{equation}
	L_w = L_p + L_i
	\label{eq:wire_induc3}
\end{equation}
Where $\mu_0$ is permeability of free air, L is the length of the wire, r is the radius of the wire copper, $L_p$ is the external self partial inductance, $L_i$ is the internal partial inductance of the wire and $L_w$ is the total self partial inductance.
The wire length and radius is not known at this point, but it assumed that it will be approximately 0.5m long and with a radius of 2mm. 
Inserting the appropriate values yields a wire inductance of 575nH.

The system was built in PLECS in order to simulate the currents and voltages and verify the designed system.
The PLECS model is shown in figure \ref{fig:plecs_schem} and can be found in the associated git repository.

\begin{figure}[h]
	\centering
	\includegraphics[width=1\linewidth]{graphics/plecs_schem.png}
	\caption[Full bridge circuit modelled in PLECS.]{Full bridge circuit with supply capacitors and wire inductance modelled using PLECS. The Motor box consists of an inductor and a resistor in series. All components apart from the MOSFETS have the same values as the chosen components.}
	\label{fig:plecs_schem}
\end{figure}	

Simulating the system at 50\% duty cycle yields a voltage ripple of approximately 24mV, which is definitely acceptable. 

It can also be noted that an effect of the inductance in the supply wires and the supply capacitors is that the supply current is low pass filtered and is thereby protected against the ripple current and only needs to supply the DC component of the load current.

The current drawn from the capacitors is shown in figure \ref{fig:cap_currents}.
Here it can be seen that the electrolytic capacitors supply the majority of the current, while the ceramic capacitors supply a small spike with high frequency content.
It should be noted that in the simulations there are no difference between the two types of capacitors other than the ESR put in series with the electrolytic capacitors. 

\begin{figure}[h]
	\centering
	%\input{graphics/cap_currents.tex}
	\caption[Capacitor current simulation in PLECS.]{Current drawn from the electrolytic and ceramic capacitors, when simulating in PLECS. }
	\label{fig:cap_currents}
\end{figure}

\subsubsection{Relay Circuitry} % (fold)
\label{ssub:relay_circuitry}
Two relays are necessary for the system, the main relay and an inrush relay.
The main relay should be able to carry and break the total stall current, 80A.
This requirement is met by the LEV100A4ANG \cite{lev100}.
It is capable of carrying up to 100A continuous current and can break significantly more.
It has a 12V coil which requires $\approx$0.5A to hold in the closed state.
As mentioned previously the inrush relay is necessary to facilitate the initial charging of the supply capacitors.
The current to the capacitors is limited only by their ESR and a resistor should be added to limit this inrush current.
Adding the resistor to the main current path would introduce considerable losses and limit the performance of the system.
The inrush relay is implemented in parallel with the main relay to supply a temporary alternate current path in which the resistor is placed.
The size of the resistor is somewhat irrelevant so long as it is large enough to protect the circuitry.
Having a larger resistance will only increase the time it takes before the capacitors are sufficiently charged.
For this reason a 180$\Omega$ 5W resistor is used.
As shown by equation \ref{eq:cap_boot_time}, the charging time can be found as 

\begin{equation}
	T_{charge} = 5\cdot R_{inrush}\cdot C_{supply} = 5\cdot 180\cdot 1320\cdot10^{-6} = 1.188 \text{[S]}
\end{equation}

Therefore, on bootup, the system will not be able to start running the motors until $\approx$1.2 S have passed.
This is estimated to be sufficient as this is well below the boot time of the remaining system.
The relay chosen for this application is the G6B-1114P \cite{g6b} with a 12V coil.
Being a significantly smaller relay, carrying up to 5A, the G6B-1114P requires only 16.7mA to hold in the closed state.\\~\\
Figure \ref{fig:relaycircuit} shows the driving circuitry for the inrush relay. 
The circuitry is identical for the main relay but can be seen in the full schematic in appendix \ref{app:controller_board_schem}.
As can be seen, the relay can be switched on and off by a signal to the MOSFET Q18.
This signal is high only when signals \texttt{INRUSH} and \texttt{EM\_DIS} are high.
\texttt{EM\_DIS} is the signal from the safety circuitry and \texttt{INRUSH} allows the user to toggle the relay.
Designing the circuit in this manner ensures that the motor will remain disengaged in case of an activated safety condition.
Finally, A flyback diode is placed in parallel with the inductor in the relay to create an alternate current path when the MOSFET is switched off.

\begin{figure}[H]
	\centering
	\includegraphics[width=.5\linewidth]{graphics/relay_circuit}
	\caption{Circuitry related to the inrush relay.}
	\label{fig:relaycircuit}
\end{figure}
% subsubsection relay_circuitry (end)


\subsubsection{Motor Current Sensing}
Measuring current in an H-Bridge with a shunt resistor can be done in a number of ways.
The shunt resistor can be placed in various positions in the H-bridge.
The three main ones are high-side, in-line and low-side placement of the shunt resistor.
\cite{shunt_placement} and \cite{Current_Sense_Circuit_Collection} specifies the advantages and disadvantages of the three configurations.
\mikkel{add a quick summary of each and highlight the selected one?} 
It was decided to use the low-side configuration as it has low common voltage, it only needs a single sided supply and because bi-directional current measurement is not needed in this application.

\paragraph{Requirements for the Current Measuring Circuit} ~\\% (fold)
\label{par:requirements_for_the_current_measuring_circuit}

The output of the current measuring circuit is an analogue signal that is measured by the ADC of the Zynq chip.
According to the Zynq ADC user guide \cite{zynq_adc}, the measurable input range is from 0V to 1V, but the maximum allowed input voltage is 1.9V according to \cite{adc_zynq_webanswer}.
The absolute maximum current through the motor is the stall current which is 80A, but the motor will run well below this level in normal operation.
The nominal current of the motor is 6A but allowing for some headroom maximum current spikes during normal operation are not expected to exceed 30A. 
It was therefore decided that the circuit  needs to be able to measure currents of at least up to 40A.
The resolution per ampere is increased by decreasing the current range that can be measured.
If the current gets any higher the ADC input should not be harmed meaning that the input voltage should not exceed 1.9V.

\paragraph{Designing the Current Measuring Circuit} ~\\% (fold)
\label{par:designing_the_current_measuring_circuit}

Placing a shunt resistor in the low-side configuration raises the voltage potential of the low-side of the H-bridge.
This may influence the gate signal required to open the MOSFETs of the H-bridge.
In addition, the shunt resistor will, regardless of placement result in a powerloss proportional to its size.
For these reasons minimizing the value of the shunt resistor is important. 
The smallest value available from the electronics supplier used at SDU provides a 200$\mu\Omega$ SMD shunt resistor.
Such a small resistance yields a minimal voltage drop and thus keeps power consumption at a minimum.\\
The resulting voltage from the motor stalling, that is an 80A current flowing through the resistor would result in only a 16mV voltage drop.
Since the input range of the ADC is 0-1V, this low voltage would yield very poor resolution in the area of actual interest, 0-40A.
An amplifier circuit is necessary.
Purpose built current-sense amplifiers exist which are used specifically for amplifying the voltage drop across a shunt resistor.
One such amplifier is the \texttt{INA286AID} from Texas Instruments \cite{INA286AID}.
It has a gain of 100, lifting the voltage resulting from motor stall to 1.6V as seen from equations \ref{eq:adc_input_voltage1} and \ref{eq:adc_input_voltage2}.
\begin{equation}
	V_{max,input} = G \cdot V_{shunt}
	\label{eq:adc_input_voltage1}
\end{equation}
\begin{equation}
	V_{max,input} = G \cdot R_{shunt} \cdot I_{stall} = 100 \cdot 200\cdot10^{-6} \cdot 80 = 1.6V
	\label{eq:adc_input_voltage2}
\end{equation}
The measurable range using this IC is 0-50A as seen from \ref{eq:adc_input_voltage3}.

\begin{equation}
	I_{max, measurable} = \frac{V_{max, measurable}}{R_{shunt}\cdot G} = \frac{1}{100 \cdot 200\cdot10^{-6} } = 50A
	\label{eq:adc_input_voltage3}
\end{equation}

It has a very low offset allowing it to be used in applications where the voltage drop across the shunt resistor is only a few mV.
\\
Using this configuraion the resolution can be calculated as:
\begin{equation}
	Res_{amp} = \frac{I_{max,measurable}}{Res_{ADC}} = \frac{50}{2^{12}}  = 12.2 mA
\end{equation}
Where $Res_{amp}$ is the resolution in amperes and $Res_{ADC}$ is the resolution of the ADC on the Zynq.
\\~\\
This design meets the required design specifications and the schematics can be seen in figure \ref{fig:currentmeasure}.
As can be seen, the \texttt{INA286} in this configuration requires only the voltage input, \texttt{POWER\_SHUNT+/-} from the schematic on figure \ref{sfig:hbridgeshunt}, to generate a suitable output which is then fed directly to the ADC through the anti-aliasing filter shown on figure \ref{sfig:ina286aidschematic}.

\begin{figure}
	\centering
	\begin{subfigure}[b]{0.49\textwidth}
		\centering
		\includegraphics[width=\linewidth]{graphics/hbridge}
		\caption{H-bridge with shunt resistor in low-side configuration.}
		\label{sfig:hbridgeshunt}	
	\end{subfigure}
	\begin{subfigure}[b]{0.49\textwidth}
		\centering
		\includegraphics[width=\linewidth]{graphics/ina286}
		\caption{Schematic of the INA286AID as used in the project.}
		\label{sfig:ina286aidschematic}
	\end{subfigure}
	\caption{Schematics relating to the current measurement circuitry.}
	\label{fig:currentmeasure}
\end{figure}

% subsubsection designing_the_current_measuring_circuit (end)



% subsection relay_circuitry (end)

\subsubsection{Endstop Detection} % (fold)
\label{ssub:endstop_detection}
As described in section \ref{subsub:safety} it was decided to use infrared transceivers to detect endstops.
It was decided to use the \texttt{TCST2103} \cite{tcst2103} as it has the wanted functionality.
It contains an infrared emitter pointing at a photo transistor, that conducts current proportional to the infrared light received.
In this project it will be used to detect if the infrared light is blocked by the cart or not. 
The circuit shown in figure \ref{fig:tcst_circuit} was realised to convert the current conducted to a voltage level. 
The output is fed to a schmitt trigger circuit in order to be able to use the result as a boolean reference.
The schmitt-trigger circuit is designed to have a high threshold of 3V and a low threshold of 1V.
The circuit can be seen in appendix \ref{app:controller_board_schem}.

\subsubsection{Voltage Rails} % (fold)
\label{subsub:voltage_rails}
In the design of the board it is necessary to determine which voltage rails are required for the system to function.
The power delivery for the MicroZed was designed by the authors in an earlier project \cite{isaswarm} and will be reused with minor changes.
This power delivery system provides, amongst other voltages, the 3.3V rail, originally intended for powering the MicroZed IO banks only.
In this system however, the RF tranceiver is also powered from this rail.
As a result a review of the circuitry around the 3.3V rail is necessary to ensure that it can provide the required power.
The MicroZed power delivery system, the encoders of the system, the endstops and part of the emergency circuitry are all driven from a 5V rail.
The Motor Driver, the HIP4081 \cite{driver} and the relay driving circuitry is driven from a 12V rail.
Finally, the motor is driven from a 24V rail, which will also be the main supply for the system.
This rail is not crucial to the design of the board as it is provided by an external, mains connected power supply and will not be explored further in this section.\\
The current requirement for each of these rails are discussed in the following paragraphs

\paragraph{3.3V:} % (fold)
\label{par:3_3v}
As mentioned, this rail is intended for powering the MicroZed IO banks.
In the original design the \texttt{LMR10510XMF} DC/DC converter is used to provide the necessary power.
This chip is capable of supplying up to 1A.
Components exist in the same series which are pin compatible and are capable of supplying up to 2A.
The RF Transceiver used in this project, however, requires only up to 15mA when receiving data and is considered unnecessary to upgrade the current capacity of the rail.
% paragraph 3_3v_ (end)

\paragraph{5V:} % (fold)
\label{par:5v}
This rail supplies, mainly, the MicroZed.
The maximum expected current draw from the microzed is 1.85A at 5V \cite{microzed}.
This includes the current drawn from the 3.3V rail.
In addition, in this design, the 5V rail also powers the encoders, endstops and emergency circuitry.
The \texttt{HEDS-5540} \cite{heds5540} encoder requires a maximum of 85mA.
The endstops are realised using the \texttt{TCST2103} infrared sensor \cite{tcst2103}.
The majority of the current supplied to this sensor is used to power the infrared LED present in the component.
This current is decided by the resistor put in series with the LED and is estimated to be around 50mA per LED for a total of 100mA.
Another 10mA is added to that figure due to the collector current possible on the transistor side.\\
Finally the emergency circuitry along with some other digital electronics are powered from the 5V rail.
As these are all digital IC's that operate on nothing but signals, their individual powers are negligible but a very conservative 25mA power budget is provided for all of the digital electronics on the 5V rail. This brings the total power budget for the 5V rail to $\approx$2.1A.
See table \ref{tab:5vpowerbudget} for a full overview.

\begin{table}
	\centering
	\begin{tabular}{l|r}
		 Component & Current [mA]\\
		 \hline
		 MicroZed & 1850\\
		 HEDS-5540 & 85\\
		 TCST2103 & 110\\
		 Digital & 25\\
		 \hline
		 Total & 2070
	\end{tabular}
	\caption{Power budget for the 5V rail}
	\label{tab:5vpowerbudget}
\end{table}

In \cite{isaswarm} the authors used a design in which the \texttt{PTH08080} is used to generate a 5V rail.
Reusing this module will save on design time as well as the budget available to the project and as such is desirable.
This module can supply 2.25A at 5V and should therefore be sufficient for this application.
The \texttt{PTH08080} design will be reused for this project.
% paragraph 5 (end)

\paragraph{12V:} % (fold)
\label{par:12v}
This rail powers the \texttt{HIP4081} motor driver, the relay coils, the bootstrap circuitry and the 5V DC/DC converter.
The \texttt{PTH08080} DC/DC converter has a maximum input voltage of 18V and must be powered from the 12V rail rather than the 24V rail.
The module can provide 2A at 5V and as such will require $\approx$0.85A from the 12V rail, assuming 100\% efficiency.

There are two relays in the design, a smaller relay for controlling the inrush current and the larger main supply relay.
Both of these require power to stay in the closed position.
The first, the \texttt{G6B}, requires 16.7mA while the former, the \texttt{LEV100A4ANG}, requires 461mA.

The motor driver of the system, the HIP4081 requires only 10mA.
As mentioned, the bootstrap circuitry is also powered from the 12V rail.
Rather than a steady supply, this circuitry requires a large peak current for short periods while charging in between switching.
For this reason the design choice here is to determine what is available and choose the component which yields the most headroom while still being economically feasible.
Amongst all of the components the total power budget for the 12V rail is $\approx$1340mA.
See table \ref{tab:12vpowerbudget} for a full overview.

\begin{table}
	\centering
	\begin{tabular}{l|r}
		 Component & Current [mA]\\
		 \hline
		 PTH08080 & 850\\
		 G6B & 16.7\\
		 LEV100A4ANG & 461\\
		 HIP4081 & 10\\
		 \hline
		 Total & 1337.7
	\end{tabular}
	\caption{Power budget for the 12V rail}
	\label{tab:12vpowerbudget}
\end{table}

The PTN78020 delivers 6A at 12V and is part of the same series as the PTH08080 described earlier.
This allows many of the same design procedures to be reused.
In addition, the 6A current limit leaves sufficient room for the current spikes expected from the bootstrap circuitry.
% paragraph 12v_ (end)

% subsection voltage_rails (end) 


\subsubsection{12V Rail Circuitry}

\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{graphics/dcdc12v}
	\caption[PTN78020H DC/DC converter circuitry.]{The \texttt{PTN78020H} DC/DC converter and the appertaining circuitry.}
	\label{fig:dcdc12v}
\end{figure}

The \texttt{PTN78020H} DC/DC converter is used to generate the 12V rail. 
The component requires input and output capacitors in order to function properly and a resistor is needed to set the desired output voltage. 
The circuit used is based on the typical application circuit shown in the datasheet \cite{PTN78020H} and is implemented as shown in figure \ref{fig:dcdc12v}.
A resistor is required from \texttt{VoADJ} to ground to set the desired output voltage, in this case 12V.
To generate 12V a 383 k$\Omega$ resistor is needed.
\texttt{VoSENSE} should be connected close to the main load to allow for more precise regulation of the output.
This feature is mainly useful when the load is placed far from the supply and can be left floating if the accuracy of the rail is not important.
It was decided to simply short it to the 12V rail at the component since the load is placed relatively close to the supply.
$\overline{\text{\texttt{IN}}}$ carries the inhibit signal.
Pulling this low will disable the output of the component.
This is done by toggling the switch \texttt{SW1}. 
This will open a MOSFET which in turn will pull the \texttt{DCDC\_EN} signal low.
The datasheet also specifies that a ceramic capacitance of at least 18.8 $\mu$F is needed at the input. 
It was chosen to use two 10 $\mu$F capacitors.
In order to ensure stability the \texttt{PTN78020H} needs an output capacitance of 330 $\mu$F.
The datasheet specifies that if the application has load transients additional capacitance should be added to improve the response of the regulator.
While the load at the 12V rail is mostly steady, it does supply the bootstrap capacitors which create a slight ripple on the rail.
It was therefore decided to use two 330 $\mu$F electrolytic capacitors in parallel.
As suggested by the datasheet an additional 20 $\mu$F of ceramic capacitance is added to the output to further improve the transient response.\\

\subsubsection{5V, 3.3V and 2.5V Rail Circuitry} % (fold) 
\label{subsub:pth08080w}
As mentioned previously the choice of these component and the design of the circuitry around them was done by the authors in a previous project \cite{isaswarm} and the details of the design will be omitted for this discussion.
The \texttt{PTH08080W} and \texttt{LMR10510XMF} are responsible for creating the 5V and 3.3V rails, respectively and the 2.5V reference is created by the \texttt{TL431AIDBZT}.
% subsection pth08080w (end)
